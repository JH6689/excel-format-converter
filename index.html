<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel æ ¼å¼è½‰æ›å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        }
        body {
            margin: 0;
            padding: 10px;
            background: linear-gradient(135deg, #DDD1E9 0%, #2e75b6 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: #F7F6F5;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        h1 {
            text-align: center;
            color: #5a4a6a;
            margin: 0 0 12px 0;
            font-size: 20px;
        }
        .form-group {
            margin-bottom: 8px;
        }
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            color: #5a4a6a;
            font-size: 12px;
        }
        input[type="text"],
        input[type="number"],
        input[type="file"] {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #DDD1E9;
            border-radius: 6px;
            font-size: 12px;
            transition: border-color 0.3s;
            background: white;
        }
        input:focus {
            outline: none;
            border-color: #2e75b6;
        }
        .row {
            display: flex;
            gap: 12px;
        }
        .row .form-group {
            flex: 1;
        }

        /* ä¸»è¦ä¸‰æ¬„ä½ˆå±€ */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 12px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #DDD1E9;
        }

        .section-title {
            background: #2e75b6;
            padding: 6px 10px;
            border-radius: 6px;
            margin: 0 0 8px 0;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* é–€å¸‚ Tab æŒ‰éˆ• */
        .store-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }
        .store-tab {
            flex: 1;
            padding: 8px 10px;
            border: 2px solid #2e75b6;
            border-radius: 6px;
            background: white;
            color: #5a4a6a;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .store-tab:hover {
            background: #F0DFEA;
        }
        .store-tab.active {
            background: #2e75b6;
            color: white;
            border-color: transparent;
        }

        .store-actions {
            display: flex;
            gap: 6px;
        }
        .btn-save, .btn-reset {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-save {
            background: #9dc3e6;
            color: #2e75b6;
        }
        .btn-save:hover {
            background: #7eb3e0;
        }
        .btn-reset {
            background: #9dc3e6;
            color: #2e75b6;
        }
        .btn-reset:hover {
            background: #7eb3e0;
        }

        .save-notice {
            background: #d4edda;
            color: #155724;
            padding: 5px 8px;
            border-radius: 6px;
            margin-top: 6px;
            font-size: 11px;
            display: none;
            text-align: center;
        }
        .save-notice.show {
            display: block;
            animation: fadeInOut 2s ease-in-out;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* ç­åˆ¥è¨­å®š 2x2 ç¶²æ ¼ */
        .shift-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .shift-config {
            background: #9dc3e6;
            border-radius: 6px;
            padding: 8px;
        }
        .shift-config-title {
            font-weight: bold;
            color: #2e75b6;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .shift-config .row {
            gap: 4px;
        }
        .shift-config input {
            padding: 4px 6px;
            font-size: 11px;
        }
        .shift-config label {
            font-size: 10px;
            margin-bottom: 2px;
            color: #2e75b6;
        }
        .shift-config .form-group {
            margin-bottom: 0;
        }

        .hint {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }

        /* æŒ‰éˆ•å€ */
        .btn-primary {
            padding: 10px 16px;
            background: #2e75b6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(164, 181, 213, 0.5);
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-download {
            padding: 10px 16px;
            background: #2e75b6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            display: none;
            margin-top: 8px;
        }
        .btn-download:hover {
            transform: translateY(-1px);
        }
        .btn-download.show {
            display: block;
        }

        .action-buttons {
            margin-top: 8px;
        }

        #status {
            margin-top: 8px;
            padding: 8px;
            border-radius: 6px;
            display: none;
            font-size: 12px;
        }
        #status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        #status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        #status.loading {
            background: #fff3cd;
            color: #856404;
            display: block;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .preview-table th, .preview-table td {
            border: 1px solid #DDD1E9;
            padding: 4px 6px;
            text-align: left;
        }
        .preview-table th {
            background: #2e75b6;
            color: white;
        }
        .preview-wrapper {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #DDD1E9;
            border-radius: 6px;
        }
        .preview-wrapper .preview-table {
            margin-top: 0;
        }
        #previewSection {
            display: none;
            margin-top: 8px;
        }
        #previewSection h3 {
            font-size: 11px;
            margin: 0 0 6px 0;
            color: #5a4a6a;
        }

        /* URL è¼¸å…¥æ¡†è¼ƒå° */
        .url-input {
            font-size: 10px;
            padding: 5px 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Excel æ ¼å¼è½‰æ›å·¥å…·</h1>

        <form id="convertForm">
            <div class="main-layout">
                <!-- å·¦å´ï¼šé–€å¸‚é¸æ“‡ + å¹´æœˆ + æª”æ¡ˆ -->
                <div class="panel">
                    <div class="section-title">1. é¸æ“‡é–€å¸‚</div>
                    <div class="store-tabs">
                        <div class="store-tab active" data-store="A" onclick="selectStore('A')">A é–€å¸‚</div>
                        <div class="store-tab" data-store="B" onclick="selectStore('B')">B é–€å¸‚</div>
                        <div class="store-tab" data-store="C" onclick="selectStore('C')">C é–€å¸‚</div>
                    </div>
                    <div id="saveNotice" class="save-notice"></div>

                    <div class="section-title" style="margin-top: 10px;">2. è½‰æ›å¹´æœˆ</div>
                    <div class="form-group">
                        <input type="text" id="yearMonth" placeholder="202510" maxlength="6">
                        <div class="hint">é è¨­ä¸‹å€‹æœˆ</div>
                    </div>

                    <div class="section-title" style="margin-top: 10px;">3. ä¸Šå‚³æª”æ¡ˆ</div>
                    <div class="form-group">
                        <input type="file" id="excelFile" accept=".xlsx,.xls" required>
                        <div class="hint">æ”¯æ´ï¼šç¸½æ§ã€ä¸€ç·šã€å‡ºç´ã€å¤–å¸¶ã€ä»»å‹™åˆ†é…</div>
                    </div>
                </div>

                <!-- ä¸­é–“ï¼šç­åˆ¥åˆ‡åˆ†è¨­å®š -->
                <div class="panel">
                    <div class="section-title">4. ç­åˆ¥åˆ‡åˆ†è¨­å®š</div>
                    <div class="hint" style="margin-bottom: 6px;">ç•™ç©º=ä¸åˆ‡åˆ† | æ—©ç­â‰¤åˆ‡é» | æ™šç­â‰¥åˆ‡é»</div>
                    <div class="shift-grid">
                        <!-- ç¸½æ§ -->
                        <div class="shift-config">
                            <div class="shift-config-title">ç¸½æ§</div>
                            <div class="row">
                                <div class="form-group">
                                    <label>æ—©ç­</label>
                                    <input type="number" id="cut_ç¸½æ§_early" value="1050" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                                <div class="form-group">
                                    <label>ä¸­ä¸‹</label>
                                    <input type="number" id="cut_ç¸½æ§_midLate" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                                <div class="form-group">
                                    <label>æ™šç­</label>
                                    <input type="number" id="cut_ç¸½æ§_late" value="1150" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                            </div>
                        </div>

                        <!-- ä¸€ç·š -->
                        <div class="shift-config">
                            <div class="shift-config-title">ä¸€ç·š</div>
                            <div class="row">
                                <div class="form-group">
                                    <label>æ—©ç­</label>
                                    <input type="number" id="cut_ä¸€ç·š_early" value="1020" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                                <div class="form-group">
                                    <label>ä¸­ä¸‹</label>
                                    <input type="number" id="cut_ä¸€ç·š_midLate" value="1150" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                                <div class="form-group">
                                    <label>æ™šç­</label>
                                    <input type="number" id="cut_ä¸€ç·š_late" value="1200" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                            </div>
                        </div>

                        <!-- å‡ºç´ -->
                        <div class="shift-config">
                            <div class="shift-config-title">å‡ºç´</div>
                            <div class="row">
                                <div class="form-group">
                                    <label>æ—©ç­</label>
                                    <input type="number" id="cut_å‡ºç´_early" value="1050" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                                <div class="form-group">
                                    <label>ä¸­ä¸‹</label>
                                    <input type="number" id="cut_å‡ºç´_midLate" value="1150" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                                <div class="form-group">
                                    <label>æ™šç­</label>
                                    <input type="number" id="cut_å‡ºç´_late" value="1200" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                            </div>
                        </div>

                        <!-- å¤–å¸¶ -->
                        <div class="shift-config">
                            <div class="shift-config-title">å¤–å¸¶</div>
                            <div class="row">
                                <div class="form-group">
                                    <label>æ—©ç­</label>
                                    <input type="number" id="cut_å¤–å¸¶_early" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                                <div class="form-group">
                                    <label>ä¸­ä¸‹</label>
                                    <input type="number" id="cut_å¤–å¸¶_midLate" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                                <div class="form-group">
                                    <label>æ™šç­</label>
                                    <input type="number" id="cut_å¤–å¸¶_late" value="1120" min="0" max="2359" placeholder="ç•™ç©º">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right; margin-top: 8px;">
                        <button type="button" class="btn-save" onclick="saveStoreSettings()">å„²å­˜é è¨­å€¼</button>
                    </div>
                </div>

                <!-- å³å´ï¼šå°ç…§è¡¨ + æŒ‰éˆ• + é è¦½ -->
                <div class="panel">
                    <div class="section-title">5. å°ç…§è¡¨ç¶²å€</div>
                    <div class="form-group">
                        <label>å“¡å·¥å·¥è™Ÿ</label>
                        <input type="text" id="employeeSheetUrl" class="url-input"
                               value="https://docs.google.com/spreadsheets/d/1ZKRX1M1GZDSdgDe5i5JSveuEaYj3ZynaYJqvrzVNwvA/edit?gid=1729770798#gid=1729770798">
                    </div>
                    <div class="form-group">
                        <label>ä»»å‹™ä»£ç¢¼</label>
                        <input type="text" id="taskCodeSheetUrl" class="url-input"
                               value="https://docs.google.com/spreadsheets/d/1ZKRX1M1GZDSdgDe5i5JSveuEaYj3ZynaYJqvrzVNwvA/edit?gid=0#gid=0">
                    </div>

                    <div class="section-title" style="margin-top: 10px;">6. åŸ·è¡Œè½‰æ›</div>
                    <div class="action-buttons">
                        <button type="submit" id="submitBtn" class="btn-primary">é–‹å§‹è½‰æ›</button>
                        <button type="button" id="downloadBtn" class="btn-download" onclick="downloadResult()">ğŸ“¥ ä¸‹è¼‰çµæœ</button>
                    </div>

                    <div id="status"></div>

                    <div id="previewSection">
                        <h3>é è¦½ï¼ˆå‰20ç­†ï¼‰</h3>
                        <div class="preview-wrapper">
                            <table class="preview-table" id="previewTable">
                                <thead>
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>å·¥è™Ÿ</th>
                                        <th>ä»£ç¢¼</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        // è¨ˆç®—ä¸‹å€‹æœˆçš„å¹´æœˆ
        function getNextMonth() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth() + 2;
            if (month > 12) {
                month = 1;
                year++;
            }
            return year.toString() + month.toString().padStart(2, '0');
        }

        // è¨­å®šé è¨­å¹´æœˆ
        document.getElementById('yearMonth').value = getNextMonth();

        // ========== é–€å¸‚è¨­å®šç®¡ç† ==========

        // é è¨­ Google Sheets URL
        const defaultUrls = {
            employeeSheetUrl: 'https://docs.google.com/spreadsheets/d/1ZKRX1M1GZDSdgDe5i5JSveuEaYj3ZynaYJqvrzVNwvA/edit?gid=1729770798#gid=1729770798',
            taskCodeSheetUrl: 'https://docs.google.com/spreadsheets/d/1ZKRX1M1GZDSdgDe5i5JSveuEaYj3ZynaYJqvrzVNwvA/edit?gid=0#gid=0'
        };

        // å„é–€å¸‚çš„é è¨­ç­åˆ¥åˆ‡åˆ†è¨­å®šï¼ˆå« Google Sheets URLï¼‰
        const storeDefaults = {
            'A': {
                'ç¸½æ§': { early: 1050, midLate: '', late: 1150 },
                'ä¸€ç·š': { early: 1020, midLate: 1150, late: 1200 },
                'å‡ºç´': { early: 1050, midLate: 1150, late: 1200 },
                'å¤–å¸¶': { early: '', midLate: '', late: 1120 },
                employeeSheetUrl: defaultUrls.employeeSheetUrl,
                taskCodeSheetUrl: defaultUrls.taskCodeSheetUrl
            },
            'B': {
                'ç¸½æ§': { early: 1050, midLate: '', late: 1150 },
                'ä¸€ç·š': { early: 1020, midLate: 1150, late: 1200 },
                'å‡ºç´': { early: 1050, midLate: 1150, late: 1200 },
                'å¤–å¸¶': { early: '', midLate: '', late: 1120 },
                employeeSheetUrl: defaultUrls.employeeSheetUrl,
                taskCodeSheetUrl: defaultUrls.taskCodeSheetUrl
            },
            'C': {
                'ç¸½æ§': { early: 1050, midLate: '', late: 1150 },
                'ä¸€ç·š': { early: 1020, midLate: 1150, late: 1200 },
                'å‡ºç´': { early: 1050, midLate: 1150, late: 1200 },
                'å¤–å¸¶': { early: '', midLate: '', late: 1120 },
                employeeSheetUrl: defaultUrls.employeeSheetUrl,
                taskCodeSheetUrl: defaultUrls.taskCodeSheetUrl
            }
        };

        // å¾ localStorage å–å¾—é–€å¸‚è¨­å®š
        function getStoredSettings(store) {
            const key = `shiftSettings_${store}`;
            const stored = localStorage.getItem(key);
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('è§£æå„²å­˜è¨­å®šå¤±æ•—:', e);
                }
            }
            return null;
        }

        // å„²å­˜é–€å¸‚è¨­å®šåˆ° localStorage
        function saveSettingsToStorage(store, settings) {
            const key = `shiftSettings_${store}`;
            localStorage.setItem(key, JSON.stringify(settings));
            localStorage.setItem('lastSelectedStore', store);
        }

        // å–å¾—ç›®å‰è¡¨å–®ä¸Šçš„è¨­å®šå€¼ï¼ˆå« Google Sheets URLï¼‰
        function getCurrentFormSettings() {
            const sheets = ['ç¸½æ§', 'ä¸€ç·š', 'å‡ºç´', 'å¤–å¸¶'];
            const settings = {};
            for (const sheet of sheets) {
                settings[sheet] = {
                    early: document.getElementById(`cut_${sheet}_early`).value,
                    midLate: document.getElementById(`cut_${sheet}_midLate`).value,
                    late: document.getElementById(`cut_${sheet}_late`).value
                };
            }
            // åŠ å…¥ Google Sheets URL
            settings.employeeSheetUrl = document.getElementById('employeeSheetUrl').value;
            settings.taskCodeSheetUrl = document.getElementById('taskCodeSheetUrl').value;
            return settings;
        }

        // å°‡è¨­å®šå€¼å¥—ç”¨åˆ°è¡¨å–®ï¼ˆå« Google Sheets URLï¼‰
        function applySettingsToForm(settings) {
            const sheets = ['ç¸½æ§', 'ä¸€ç·š', 'å‡ºç´', 'å¤–å¸¶'];
            for (const sheet of sheets) {
                if (settings[sheet]) {
                    document.getElementById(`cut_${sheet}_early`).value = settings[sheet].early || '';
                    document.getElementById(`cut_${sheet}_midLate`).value = settings[sheet].midLate || '';
                    document.getElementById(`cut_${sheet}_late`).value = settings[sheet].late || '';
                }
            }
            // å¥—ç”¨ Google Sheets URL
            if (settings.employeeSheetUrl !== undefined) {
                document.getElementById('employeeSheetUrl').value = settings.employeeSheetUrl;
            }
            if (settings.taskCodeSheetUrl !== undefined) {
                document.getElementById('taskCodeSheetUrl').value = settings.taskCodeSheetUrl;
            }
        }

        // è¼‰å…¥é–€å¸‚è¨­å®šï¼ˆå„ªå…ˆä½¿ç”¨å·²å„²å­˜çš„ï¼Œå¦å‰‡ç”¨é è¨­å€¼ï¼‰
        function loadStoreSettings(store) {
            const stored = getStoredSettings(store);
            if (stored) {
                applySettingsToForm(stored);
                console.log(`è¼‰å…¥ ${store} é–€å¸‚çš„å„²å­˜è¨­å®š`);
            } else {
                applySettingsToForm(storeDefaults[store]);
                console.log(`è¼‰å…¥ ${store} é–€å¸‚çš„é è¨­è¨­å®š`);
            }
        }

        // å–å¾—ç›®å‰é¸ä¸­çš„é–€å¸‚
        function getCurrentStore() {
            const activeTab = document.querySelector('.store-tab.active');
            return activeTab ? activeTab.dataset.store : 'A';
        }

        // é–€å¸‚åˆ‡æ›äº‹ä»¶ï¼ˆTab é»æ“Šï¼‰
        function selectStore(store) {
            // æ›´æ–° Tab æ¨£å¼
            document.querySelectorAll('.store-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.store-tab[data-store="${store}"]`).classList.add('active');

            // è¼‰å…¥è©²é–€å¸‚çš„è¨­å®š
            loadStoreSettings(store);
            localStorage.setItem('lastSelectedStore', store);
        }

        // å„²å­˜ç•¶å‰é–€å¸‚è¨­å®š
        function saveStoreSettings() {
            const store = getCurrentStore();
            const settings = getCurrentFormSettings();
            saveSettingsToStorage(store, settings);

            // é¡¯ç¤ºå„²å­˜æˆåŠŸæç¤º
            const notice = document.getElementById('saveNotice');
            notice.textContent = `âœ“ ${store} é–€å¸‚è¨­å®šå·²å„²å­˜`;
            notice.classList.remove('show');
            void notice.offsetWidth; // è§¸ç™¼ reflow ä»¥é‡æ–°æ’­æ”¾å‹•ç•«
            notice.classList.add('show');

            setTimeout(() => {
                notice.classList.remove('show');
            }, 2000);
        }

        // æ¢å¾©é è¨­å€¼
        function resetToDefault() {
            const store = getCurrentStore();
            applySettingsToForm(storeDefaults[store]);

            const notice = document.getElementById('saveNotice');
            notice.textContent = `â†© å·²æ¢å¾© ${store} é–€å¸‚é è¨­å€¼`;
            notice.classList.remove('show');
            void notice.offsetWidth;
            notice.classList.add('show');

            setTimeout(() => {
                notice.classList.remove('show');
            }, 2000);
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–é–€å¸‚è¨­å®š
        function initStoreSettings() {
            const lastStore = localStorage.getItem('lastSelectedStore') || 'A';
            // è¨­å®š active tab
            document.querySelectorAll('.store-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTab = document.querySelector(`.store-tab[data-store="${lastStore}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            loadStoreSettings(lastStore);
        }

        // åŸ·è¡Œåˆå§‹åŒ–
        initStoreSettings();

        // ========== ç­åˆ¥åˆ‡åˆ†è¨­å®š ==========

        // å–å¾—å„è·å‹™çš„åˆ‡åˆ†é»è¨­å®š
        function getShiftCutoffs() {
            const sheets = ['ç¸½æ§', 'ä¸€ç·š', 'å‡ºç´', 'å¤–å¸¶'];
            const cutoffs = {};

            for (const sheet of sheets) {
                const earlyVal = document.getElementById(`cut_${sheet}_early`).value;
                const midLateVal = document.getElementById(`cut_${sheet}_midLate`).value;
                const lateVal = document.getElementById(`cut_${sheet}_late`).value;

                cutoffs[sheet] = {
                    early: earlyVal ? parseInt(earlyVal) : null,
                    midLate: midLateVal ? parseInt(midLateVal) : null,
                    late: lateVal ? parseInt(lateVal) : null
                };
            }

            return cutoffs;
        }

        // å¾ Google Sheets URL æå–è³‡è¨Šä¸¦å–å¾— CSV URL
        function getGoogleSheetCsvUrl(url) {
            if (!url) return null;
            const spreadsheetIdMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            const gidMatch = url.match(/gid=(\d+)/);
            if (!spreadsheetIdMatch) return null;
            const gid = gidMatch ? gidMatch[1] : '0';
            return `https://docs.google.com/spreadsheets/d/${spreadsheetIdMatch[1]}/export?format=csv&gid=${gid}`;
        }

        // è§£æ CSV
        function parseCsv(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            for (const line of lines) {
                if (!line.trim()) continue;
                const row = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                result.push(row);
            }
            return result;
        }

        // è¼‰å…¥ Google Sheets è³‡æ–™
        async function fetchGoogleSheet(url) {
            const csvUrl = getGoogleSheetCsvUrl(url);
            if (!csvUrl) return null;

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥');
                const text = await response.text();
                return parseCsv(text);
            } catch (error) {
                console.error('è¼‰å…¥ Google Sheet å¤±æ•—:', error);
                return null;
            }
        }

        // è¼‰å…¥å“¡å·¥å°ç…§è¡¨
        async function loadEmployeeMapping(url) {
            const rows = await fetchGoogleSheet(url);
            if (!rows) return {};

            const mapping = {};
            for (let i = 1; i < rows.length; i++) {
                if (rows[i][0] && rows[i][1]) {
                    mapping[rows[i][0].trim()] = rows[i][1].trim();
                }
            }
            return mapping;
        }

        // è¼‰å…¥ä»»å‹™ä»£ç¢¼å°ç…§è¡¨ï¼ˆæ”¯æ´å¤šå€‹è¡¨å–®é¡å‹ï¼ŒåŒ…å«ä¸­ä¸‹ç­ï¼‰
        async function loadAllTaskCodeMappings(url) {
            const rows = await fetchGoogleSheet(url);

            // å®šç¾©è¦è™•ç†çš„è¡¨å–®é¡å‹åŠå…¶åœ¨é›²ç«¯å°ç…§è¡¨çš„æœå°‹é—œéµå­—
            // ç¾åœ¨æ”¯æ´å››ç¨®ç­åˆ¥ï¼šæ—©ã€ä¸­ã€ä¸­ä¸‹ã€æ™š
            const sheetTypes = {
                'ç¸½æ§': { searchKey: 'ç¸½æ§', early: null, middle: null, midLate: null, late: null },
                'ä¸€ç·š': { searchKey: 'ä¸€ç·š', early: null, middle: null, midLate: null, late: null },
                'å‡ºç´': { searchKey: 'å‡ºç´', early: null, middle: null, midLate: null, late: null },
                'å¤–å¸¶': { searchKey: 'å¤–', early: null, middle: null, midLate: null, late: null }
            };

            if (!rows) {
                console.error('ç„¡æ³•è¼‰å…¥ä»»å‹™ä»£ç¢¼å°ç…§è¡¨');
                return {
                    'ç¸½æ§': { early: null, middle: null, midLate: null, late: null },
                    'ä¸€ç·š': { early: null, middle: null, midLate: null, late: null },
                    'å‡ºç´': { early: null, middle: null, midLate: null, late: null },
                    'å¤–å¸¶': { early: null, middle: null, midLate: null, late: null }
                };
            }

            console.log('Google Sheets å°ç…§è¡¨å…§å®¹:', rows);

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const firstCol = (row[0] || '').trim();
                const taskCode = (row[1] || row[0] || '').trim();

                // æª¢æŸ¥æ¯ç¨®è¡¨å–®é¡å‹
                for (const [sheetName, config] of Object.entries(sheetTypes)) {
                    const searchKey = config.searchKey;

                    // ç‰¹æ®Šè™•ç†ã€Œå¤–å¸¶ã€ï¼šæœå°‹ã€Œå¤–æ—©ã€ã€Œå¤–ä¸­ã€ã€Œå¤–ä¸­ä¸‹ã€ã€Œå¤–ä¸‹ã€ã€Œå¤–æ™šã€
                    if (sheetName === 'å¤–å¸¶') {
                        const isExternalOnly = firstCol.includes('å¤–') && !firstCol.includes('ç¸½æ§') && !firstCol.includes('ä¸€ç·š') && !firstCol.includes('å‡ºç´');
                        if (!isExternalOnly) continue;

                        if (firstCol.includes('å¤–æ—©') || (firstCol.includes('æ—©'))) {
                            config.early = taskCode;
                        } else if (firstCol.includes('å¤–ä¸­ä¸‹') || firstCol.includes('å¤–ä¸‹') || (firstCol.includes('ä¸­ä¸‹') || firstCol.includes('ä¸‹'))) {
                            config.midLate = taskCode;
                        } else if (firstCol.includes('å¤–ä¸­') || firstCol.includes('ä¸­')) {
                            config.middle = taskCode;
                        } else if (firstCol.includes('å¤–æ™š') || firstCol.includes('æ™š')) {
                            config.late = taskCode;
                        }
                    } else {
                        // å…¶ä»–è¡¨å–®é¡å‹ï¼šæœå°‹ã€ŒXXæ—©ã€ã€ŒXXä¸­ã€ã€ŒXXä¸­ä¸‹ã€ã€ŒXXä¸‹ã€ã€ŒXXæ™šã€
                        if (firstCol.includes(searchKey)) {
                            if (firstCol.includes('æ—©')) {
                                config.early = taskCode;
                            } else if (firstCol.includes('ä¸­ä¸‹') || (firstCol.includes('ä¸‹') && !firstCol.includes('æ™š'))) {
                                config.midLate = taskCode;
                            } else if (firstCol.includes('ä¸­')) {
                                config.middle = taskCode;
                            } else if (firstCol.includes('æ™š')) {
                                config.late = taskCode;
                            }
                        }
                    }
                }
            }

            // è½‰æ›ç‚ºçµæœæ ¼å¼ï¼ˆæ‰¾ä¸åˆ°ä»£ç¢¼å‰‡ç‚º nullï¼Œä¹‹å¾Œæœƒç•¥éï¼‰
            const result = {};
            for (const [sheetName, config] of Object.entries(sheetTypes)) {
                result[sheetName] = {
                    early: config.early || null,
                    middle: config.middle || null,
                    midLate: config.midLate || null,
                    late: config.late || null
                };
            }

            console.log('All task code mappings:', result);
            return result;
        }

        // è¼‰å…¥ä»»å‹™åˆ†é…å°ç…§è¡¨ï¼ˆä»»å‹™åç¨± â†’ ä»»å‹™ä»£ç¢¼ï¼‰
        // ä½¿ç”¨èˆ‡ç­åˆ¥ç›¸åŒçš„å°ç…§è¡¨ï¼Œæ’é™¤ç­åˆ¥ç›¸é—œé …ç›®
        function loadTaskAssignMapping(rows) {
            if (!rows) {
                console.log('ç„¡æ³•è¼‰å…¥ä»»å‹™åˆ†é…å°ç…§è¡¨');
                return {};
            }

            const mapping = {};
            // ç¬¬ä¸€æ¬„æ˜¯ä»»å‹™åç¨±ï¼Œç¬¬äºŒæ¬„æ˜¯ä»£ç¢¼
            // æ’é™¤ç­åˆ¥ç›¸é—œçš„é …ç›®
            const shiftPatterns = ['ç¸½æ§æ—©', 'ç¸½æ§ä¸­', 'ç¸½æ§æ™š', 'ç¸½æ§ä¸‹',
                                   'ä¸€ç·šæ—©', 'ä¸€ç·šä¸­', 'ä¸€ç·šæ™š', 'ä¸€ç·šä¸‹',
                                   'å‡ºç´æ—©', 'å‡ºç´ä¸­', 'å‡ºç´æ™š', 'å‡ºç´ä¸‹',
                                   'å¤–æ—©', 'å¤–ä¸­', 'å¤–æ™š', 'å¤–ä¸‹'];

            for (let i = 0; i < rows.length; i++) {
                const taskName = (rows[i][0] || '').trim();
                const taskCode = (rows[i][1] || '').trim();

                // è·³éç­åˆ¥ç›¸é—œé …ç›®
                const isShiftItem = shiftPatterns.some(pattern => taskName.includes(pattern));
                if (isShiftItem) {
                    continue;
                }

                if (taskName && taskCode) {
                    mapping[taskName] = taskCode;
                }
            }

            console.log('Task assign mapping loaded:', mapping);
            return mapping;
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ç­åˆ¥æ™‚é–“
        function isValidShiftTime(value) {
            if (value === null || value === undefined) return false;
            const str = String(value).trim();
            return /^\d{3,4}$/.test(str);
        }

        // åˆ¤æ–·ç­åˆ¥ï¼ˆæ”¯æ´å„è·å‹™ç¨ç«‹åˆ‡åˆ†é»ï¼‰
        // cutoffs: { early: number|null, midLate: number|null, late: number|null }
        // è¿”å›: 'early', 'middle', 'midLate', 'late'
        function getShiftType(timeValue, cutoffs) {
            const time = parseInt(timeValue, 10);
            if (isNaN(time)) return null;

            const { early, midLate, late } = cutoffs;

            // æƒ…æ³1: åªæœ‰æ™šç­åˆ‡é»ï¼ˆå¦‚å¤–å¸¶é è¨­ï¼‰
            // æ™šç­åˆ‡é»å¾Œ(å«)ç‚ºæ™šç­ï¼Œå…¶ä»–ç‚ºæ—©ç­
            if (early === null && midLate === null && late !== null) {
                return time >= late ? 'late' : 'early';
            }

            // æƒ…æ³2: åªæœ‰æ—©ç­å’Œæ™šç­åˆ‡é»ï¼ˆå¦‚ç¸½æ§é è¨­ï¼‰
            // æ—©ç­åˆ‡é»å‰(å«)ç‚ºæ—©ç­ï¼Œæ™šç­åˆ‡é»å¾Œ(å«)ç‚ºæ™šç­ï¼Œå…¶ä»–ç‚ºä¸­ç­
            if (early !== null && midLate === null && late !== null) {
                if (time <= early) return 'early';
                if (time >= late) return 'late';
                return 'middle';
            }

            // æƒ…æ³3: æœ‰æ—©ç­ã€ä¸­ä¸‹ã€æ™šç­åˆ‡é»ï¼ˆå¦‚ä¸€ç·šã€å‡ºç´é è¨­ï¼‰
            // æ—©ç­åˆ‡é»å‰(å«)ç‚ºæ—©ç­
            // ä¸­ä¸‹åˆ‡é»åˆ°æ™šç­åˆ‡é»ä¹‹é–“(å«ä¸­ä¸‹ï¼Œä¸å«æ™šç­)ç‚ºä¸­ä¸‹ç­
            // æ™šç­åˆ‡é»å¾Œ(å«)ç‚ºæ™šç­
            // å…¶é¤˜ç‚ºä¸­ç­
            if (early !== null && midLate !== null && late !== null) {
                if (time <= early) return 'early';
                if (time >= late) return 'late';
                if (time >= midLate && time < late) return 'midLate';
                return 'middle';
            }

            // å…¶ä»–æƒ…æ³ï¼šé è¨­è¿”å›ä¸­ç­
            return 'middle';
        }

        // å–å¾—æŸæœˆå¤©æ•¸
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(year, month, day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        let convertedData = null;

        // è¡¨å–®æäº¤
        document.getElementById('convertForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('excelFile');
            const yearMonth = document.getElementById('yearMonth').value || getNextMonth();
            const employeeSheetUrl = document.getElementById('employeeSheetUrl').value;
            const taskCodeSheetUrl = document.getElementById('taskCodeSheetUrl').value;

            // å–å¾—å„è·å‹™çš„åˆ‡åˆ†é»è¨­å®š
            const shiftCutoffs = getShiftCutoffs();
            console.log('Shift cutoffs:', shiftCutoffs);

            if (!fileInput.files[0]) {
                showStatus('è«‹é¸æ“‡æª”æ¡ˆ', 'error');
                return;
            }

            showStatus('è½‰æ›ä¸­ï¼Œè«‹ç¨å€™...', 'loading');
            document.getElementById('submitBtn').disabled = true;

            try {
                // è§£æå¹´æœˆ
                let year, month;
                if (yearMonth.length === 6) {
                    year = parseInt(yearMonth.substring(0, 4), 10);
                    month = parseInt(yearMonth.substring(4, 6), 10);
                } else {
                    const now = new Date();
                    year = now.getFullYear();
                    month = now.getMonth() + 2;
                    if (month > 12) { month = 1; year++; }
                }

                const daysInMonth = getDaysInMonth(year, month);

                // è®€å– Excel æª”æ¡ˆ
                const fileData = await fileInput.files[0].arrayBuffer();
                const workbook = XLSX.read(fileData, { type: 'array' });

                // å®šç¾©è¦è™•ç†çš„è¡¨å–®ï¼ˆç­åˆ¥è¡¨å–®ï¼‰
                const sheetsToProcess = ['ç¸½æ§', 'ä¸€ç·š', 'å‡ºç´', 'å¤–å¸¶'];
                const foundSheets = sheetsToProcess.filter(name => workbook.SheetNames.includes(name));

                // æª¢æŸ¥æ˜¯å¦æœ‰ä»»å‹™åˆ†é…è¡¨å–®
                const hasTaskAssignSheet = workbook.SheetNames.includes('ä»»å‹™åˆ†é…');

                if (foundSheets.length === 0 && !hasTaskAssignSheet) {
                    showStatus('æ‰¾ä¸åˆ°å¯è™•ç†çš„è¡¨å–®ï¼ˆç¸½æ§ã€ä¸€ç·šã€å‡ºç´ã€å¤–å¸¶ã€ä»»å‹™åˆ†é…ï¼‰', 'error');
                    return;
                }

                // è¼‰å…¥å°ç…§è¡¨
                const [employeeMapping, taskCodeRows] = await Promise.all([
                    loadEmployeeMapping(employeeSheetUrl),
                    fetchGoogleSheet(taskCodeSheetUrl)
                ]);

                // å¾å°ç…§è¡¨è§£æç­åˆ¥ä»£ç¢¼å’Œä»»å‹™åˆ†é…ä»£ç¢¼
                const allTaskCodes = await loadAllTaskCodeMappings(taskCodeSheetUrl);
                const taskAssignMapping = loadTaskAssignMapping(taskCodeRows);

                console.log('Employee mapping:', employeeMapping);
                console.log('All task codes:', allTaskCodes);
                console.log('Task assign mapping:', taskAssignMapping);

                const result = [];

                // è™•ç†æ¯å€‹è¡¨å–®
                for (const sheetName of foundSheets) {
                    const sheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    const taskCodes = allTaskCodes[sheetName];
                    const cutoffs = shiftCutoffs[sheetName];

                    console.log(`Processing sheet: ${sheetName}, taskCodes:`, taskCodes, 'cutoffs:', cutoffs);

                    // å¾ç¬¬äºŒè¡Œé–‹å§‹ï¼ˆç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œï¼‰
                    for (let rowIndex = 1; rowIndex < data.length; rowIndex++) {
                        const row = data[rowIndex];
                        const employeeName = String(row[0] || '').trim();
                        if (!employeeName) continue;

                        const employeeId = employeeMapping[employeeName] || employeeName;

                        for (let colIndex = 1; colIndex <= daysInMonth && colIndex < row.length; colIndex++) {
                            const cellValue = row[colIndex];
                            const cellStr = String(cellValue).trim();

                            if (isValidShiftTime(cellStr)) {
                                const day = colIndex;
                                const date = formatDate(year, month, day);
                                const shiftType = getShiftType(cellStr, cutoffs);

                                let taskCode;
                                if (shiftType === 'early') {
                                    taskCode = taskCodes.early;
                                } else if (shiftType === 'middle') {
                                    taskCode = taskCodes.middle;
                                } else if (shiftType === 'midLate') {
                                    taskCode = taskCodes.midLate;
                                } else if (shiftType === 'late') {
                                    taskCode = taskCodes.late;
                                }

                                // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰ä»£ç¢¼ï¼Œç•¥éä¸è½‰æ›
                                if (taskCode) {
                                    result.push({
                                        date: date,
                                        employeeId: employeeId,
                                        taskCode: taskCode
                                    });
                                }
                            }
                        }
                    }
                }

                // è™•ç†ä»»å‹™åˆ†é…è¡¨å–®
                let processedTaskAssign = false;
                if (hasTaskAssignSheet && taskAssignMapping && Object.keys(taskAssignMapping).length > 0) {
                    const sheet = workbook.Sheets['ä»»å‹™åˆ†é…'];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                    console.log('Processing sheet: ä»»å‹™åˆ†é…');
                    console.log('  data rows:', data.length);

                    // ä»»å‹™åˆ†é…è¡¨å–®çµæ§‹ï¼š
                    // ç¬¬ä¸€æ¬„ï¼šä»»å‹™åç¨±
                    // ç¬¬äºŒæ¬„ä»¥å¾Œï¼šæ—¥æœŸï¼ˆ1è™Ÿåˆ°æœ€å¾Œä¸€è™Ÿï¼‰
                    // å„²å­˜æ ¼å…§å®¹ï¼šå“¡å·¥å§“å

                    for (let rowIndex = 1; rowIndex < data.length; rowIndex++) {
                        const row = data[rowIndex];
                        const taskName = String(row[0] || '').trim();
                        if (!taskName) continue;

                        // æŸ¥æ‰¾ä»»å‹™ä»£ç¢¼
                        const taskCode = taskAssignMapping[taskName];
                        if (!taskCode) {
                            console.log(`  è·³éä»»å‹™: ${taskName} (ç„¡å°æ‡‰ä»£ç¢¼)`);
                            continue;
                        }

                        // è™•ç†æ¯ä¸€å¤©
                        for (let colIndex = 1; colIndex <= daysInMonth && colIndex < row.length; colIndex++) {
                            const cellValue = row[colIndex];
                            const employeeName = String(cellValue).trim();

                            if (employeeName) {
                                const day = colIndex;
                                const date = formatDate(year, month, day);
                                const employeeId = employeeMapping[employeeName] || employeeName;

                                result.push({
                                    date: date,
                                    employeeId: employeeId,
                                    taskCode: taskCode
                                });
                                processedTaskAssign = true;
                            }
                        }
                    }
                } else if (hasTaskAssignSheet) {
                    console.log('ä»»å‹™åˆ†é…è¡¨å–®å­˜åœ¨ï¼Œä½†å°ç…§è¡¨ä¸­ç„¡å°æ‡‰çš„ä»»å‹™ä»£ç¢¼ï¼Œè·³éè™•ç†');
                }

                // çµ±è¨ˆè™•ç†çš„è¡¨å–®
                const processedSheets = [...foundSheets];
                if (processedTaskAssign) {
                    processedSheets.push('ä»»å‹™åˆ†é…');
                }

                convertedData = result;

                if (result.length === 0) {
                    showStatus(`æ²’æœ‰å¯è½‰æ›çš„è³‡æ–™ã€‚è«‹ç¢ºèªå°ç…§è¡¨æ˜¯å¦å…¬é–‹ä¸”æœ‰å°æ‡‰ä»£ç¢¼`, 'error');
                } else {
                    showStatus(`è½‰æ›æˆåŠŸï¼å…± ${result.length} ç­†ï¼ˆ${processedSheets.join('ã€')}ï¼‰`, 'success');
                }
                showPreview(result);

            } catch (error) {
                showStatus('ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
                console.error(error);
            } finally {
                document.getElementById('submitBtn').disabled = false;
            }
        });

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        function showPreview(data) {
            const tbody = document.querySelector('#previewTable tbody');
            tbody.innerHTML = '';

            const previewData = data.slice(0, 20);
            previewData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.employeeId}</td>
                    <td>${row.taskCode}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('previewSection').style.display = 'block';

            // é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•
            if (data.length > 0) {
                document.getElementById('downloadBtn').classList.add('show');
            } else {
                document.getElementById('downloadBtn').classList.remove('show');
            }
        }

        function downloadResult() {
            if (!convertedData) {
                alert('æ²’æœ‰å¯ä¸‹è¼‰çš„è³‡æ–™');
                return;
            }

            // å»ºç«‹ Excel å·¥ä½œè¡¨
            const wsData = [
                ['æ—¥æœŸ', 'å·¥è™Ÿ', 'ä»»å‹™ä»£ç¢¼'],
                ...convertedData.map(row => [row.date, row.employeeId, row.taskCode])
            ];

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 20 }];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è½‰æ›çµæœ');

            XLSX.writeFile(wb, 'è½‰æ›çµæœ.xlsx');
        }
    </script>
</body>
</html>
