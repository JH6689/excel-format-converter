<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 格式轉換工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        }
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"],
        input[type="number"],
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        .row {
            display: flex;
            gap: 20px;
        }
        .row .form-group {
            flex: 1;
        }
        .section-title {
            background: #f5f5f5;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 25px 0 15px 0;
            color: #666;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .hint {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        #status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        #status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        #status.loading {
            background: #fff3cd;
            color: #856404;
            display: block;
        }
        .preview-table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background: #f5f5f5;
        }
        #previewSection {
            display: none;
            margin-top: 20px;
        }
        #downloadBtn {
            margin-top: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .collapsible {
            cursor: pointer;
            user-select: none;
        }
        .collapsible::after {
            content: ' [展開]';
            font-size: 12px;
            color: #667eea;
        }
        .collapsible.active::after {
            content: ' [收起]';
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.show {
            max-height: 500px;
        }
        .shift-preview {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .shift-tag {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        .shift-tag.early {
            background: #d4edda;
            color: #155724;
        }
        .shift-tag.middle {
            background: #fff3cd;
            color: #856404;
        }
        .shift-tag.late {
            background: #cce5ff;
            color: #004085;
        }
        .shift-config {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .shift-config-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .shift-config .row {
            gap: 10px;
        }
        .shift-config input {
            padding: 8px;
            font-size: 13px;
        }
        .shift-config label {
            font-size: 12px;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Excel 格式轉換工具</h1>

        <form id="convertForm">
            <div class="form-group">
                <label for="excelFile">上傳 Excel 檔案</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" required>
                <div class="hint">支援表單：總控、一線、出納、外帶、任務分配</div>
            </div>

            <div class="form-group">
                <label for="yearMonth">轉換年月</label>
                <input type="text" id="yearMonth" placeholder="例如: 202510" maxlength="6">
                <div class="hint">預設為下個月</div>
            </div>

            <div class="section-title">各職務班別切分設定</div>
            <div class="hint" style="margin-bottom: 15px;">留空表示不從此點切分。早班切點前(含)為早班，晚班切點後(含)為晚班，中下切點到晚班切點之間為中下班，其餘為中班。</div>

            <!-- 總控 -->
            <div class="shift-config">
                <div class="shift-config-title">總控</div>
                <div class="row">
                    <div class="form-group">
                        <label>早班切點</label>
                        <input type="number" id="cut_總控_early" value="1050" min="0" max="2359" placeholder="留空不切">
                    </div>
                    <div class="form-group">
                        <label>中下切點</label>
                        <input type="number" id="cut_總控_midLate" min="0" max="2359" placeholder="留空不切">
                    </div>
                    <div class="form-group">
                        <label>晚班切點</label>
                        <input type="number" id="cut_總控_late" value="1150" min="0" max="2359" placeholder="留空不切">
                    </div>
                </div>
            </div>

            <!-- 一線 -->
            <div class="shift-config">
                <div class="shift-config-title">一線</div>
                <div class="row">
                    <div class="form-group">
                        <label>早班切點</label>
                        <input type="number" id="cut_一線_early" value="1050" min="0" max="2359" placeholder="留空不切">
                    </div>
                    <div class="form-group">
                        <label>中下切點</label>
                        <input type="number" id="cut_一線_midLate" value="1150" min="0" max="2359" placeholder="留空不切">
                    </div>
                    <div class="form-group">
                        <label>晚班切點</label>
                        <input type="number" id="cut_一線_late" value="1200" min="0" max="2359" placeholder="留空不切">
                    </div>
                </div>
            </div>

            <!-- 出納 -->
            <div class="shift-config">
                <div class="shift-config-title">出納</div>
                <div class="row">
                    <div class="form-group">
                        <label>早班切點</label>
                        <input type="number" id="cut_出納_early" value="1050" min="0" max="2359" placeholder="留空不切">
                    </div>
                    <div class="form-group">
                        <label>中下切點</label>
                        <input type="number" id="cut_出納_midLate" value="1150" min="0" max="2359" placeholder="留空不切">
                    </div>
                    <div class="form-group">
                        <label>晚班切點</label>
                        <input type="number" id="cut_出納_late" value="1200" min="0" max="2359" placeholder="留空不切">
                    </div>
                </div>
            </div>

            <!-- 外帶 -->
            <div class="shift-config">
                <div class="shift-config-title">外帶</div>
                <div class="row">
                    <div class="form-group">
                        <label>早班切點</label>
                        <input type="number" id="cut_外帶_early" min="0" max="2359" placeholder="留空不切">
                    </div>
                    <div class="form-group">
                        <label>中下切點</label>
                        <input type="number" id="cut_外帶_midLate" min="0" max="2359" placeholder="留空不切">
                    </div>
                    <div class="form-group">
                        <label>晚班切點</label>
                        <input type="number" id="cut_外帶_late" value="1150" min="0" max="2359" placeholder="留空不切">
                    </div>
                </div>
            </div>

            <div class="section-title collapsible" onclick="toggleSection(this)">
                進階設定 - Google Sheets 對照表網址
            </div>
            <div class="collapsible-content">
                <div class="form-group">
                    <label for="employeeSheetUrl">員工工號對照表</label>
                    <input type="text" id="employeeSheetUrl"
                           value="https://docs.google.com/spreadsheets/d/1ZKRX1M1GZDSdgDe5i5JSveuEaYj3ZynaYJqvrzVNwvA/edit?gid=1729770798#gid=1729770798">
                    <div class="hint">姓名對照工號的 Google Sheets（需設為公開）</div>
                </div>
                <div class="form-group">
                    <label for="taskCodeSheetUrl">任務代碼對照表</label>
                    <input type="text" id="taskCodeSheetUrl"
                           value="https://docs.google.com/spreadsheets/d/1ZKRX1M1GZDSdgDe5i5JSveuEaYj3ZynaYJqvrzVNwvA/edit?gid=0#gid=0">
                    <div class="hint">任務代碼對照表（班別代碼 + 任務分配代碼共用，需設為公開）</div>
                </div>
            </div>

            <button type="submit" id="submitBtn">開始轉換</button>
        </form>

        <div id="status"></div>

        <div id="previewSection">
            <h3>轉換結果預覽（前20筆）</h3>
            <table class="preview-table" id="previewTable">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>工號</th>
                        <th>任務代碼</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button type="button" id="downloadBtn" onclick="downloadResult()">下載轉換結果</button>
        </div>
    </div>

    <script>
        // 計算下個月的年月
        function getNextMonth() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth() + 2;
            if (month > 12) {
                month = 1;
                year++;
            }
            return year.toString() + month.toString().padStart(2, '0');
        }

        // 設定預設年月
        document.getElementById('yearMonth').value = getNextMonth();

        // 取得各職務的切分點設定
        function getShiftCutoffs() {
            const sheets = ['總控', '一線', '出納', '外帶'];
            const cutoffs = {};

            for (const sheet of sheets) {
                const earlyVal = document.getElementById(`cut_${sheet}_early`).value;
                const midLateVal = document.getElementById(`cut_${sheet}_midLate`).value;
                const lateVal = document.getElementById(`cut_${sheet}_late`).value;

                cutoffs[sheet] = {
                    early: earlyVal ? parseInt(earlyVal) : null,
                    midLate: midLateVal ? parseInt(midLateVal) : null,
                    late: lateVal ? parseInt(lateVal) : null
                };
            }

            return cutoffs;
        }

        // 展開/收起進階設定
        function toggleSection(element) {
            element.classList.toggle('active');
            const content = element.nextElementSibling;
            content.classList.toggle('show');
        }

        // 從 Google Sheets URL 提取資訊並取得 CSV URL
        function getGoogleSheetCsvUrl(url) {
            if (!url) return null;
            const spreadsheetIdMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            const gidMatch = url.match(/gid=(\d+)/);
            if (!spreadsheetIdMatch) return null;
            const gid = gidMatch ? gidMatch[1] : '0';
            return `https://docs.google.com/spreadsheets/d/${spreadsheetIdMatch[1]}/export?format=csv&gid=${gid}`;
        }

        // 解析 CSV
        function parseCsv(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            for (const line of lines) {
                if (!line.trim()) continue;
                const row = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                result.push(row);
            }
            return result;
        }

        // 載入 Google Sheets 資料
        async function fetchGoogleSheet(url) {
            const csvUrl = getGoogleSheetCsvUrl(url);
            if (!csvUrl) return null;

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('無法載入');
                const text = await response.text();
                return parseCsv(text);
            } catch (error) {
                console.error('載入 Google Sheet 失敗:', error);
                return null;
            }
        }

        // 載入員工對照表
        async function loadEmployeeMapping(url) {
            const rows = await fetchGoogleSheet(url);
            if (!rows) return {};

            const mapping = {};
            for (let i = 1; i < rows.length; i++) {
                if (rows[i][0] && rows[i][1]) {
                    mapping[rows[i][0].trim()] = rows[i][1].trim();
                }
            }
            return mapping;
        }

        // 載入任務代碼對照表（支援多個表單類型，包含中下班）
        async function loadAllTaskCodeMappings(url) {
            const rows = await fetchGoogleSheet(url);

            // 定義要處理的表單類型及其在雲端對照表的搜尋關鍵字
            // 現在支援四種班別：早、中、中下、晚
            const sheetTypes = {
                '總控': { searchKey: '總控', early: null, middle: null, midLate: null, late: null },
                '一線': { searchKey: '一線', early: null, middle: null, midLate: null, late: null },
                '出納': { searchKey: '出納', early: null, middle: null, midLate: null, late: null },
                '外帶': { searchKey: '外', early: null, middle: null, midLate: null, late: null }
            };

            if (!rows) {
                console.error('無法載入任務代碼對照表');
                return {
                    '總控': { early: null, middle: null, midLate: null, late: null },
                    '一線': { early: null, middle: null, midLate: null, late: null },
                    '出納': { early: null, middle: null, midLate: null, late: null },
                    '外帶': { early: null, middle: null, midLate: null, late: null }
                };
            }

            console.log('Google Sheets 對照表內容:', rows);

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const firstCol = (row[0] || '').trim();
                const taskCode = (row[1] || row[0] || '').trim();

                // 檢查每種表單類型
                for (const [sheetName, config] of Object.entries(sheetTypes)) {
                    const searchKey = config.searchKey;

                    // 特殊處理「外帶」：搜尋「外早」「外中」「外中下」「外下」「外晚」
                    if (sheetName === '外帶') {
                        const isExternalOnly = firstCol.includes('外') && !firstCol.includes('總控') && !firstCol.includes('一線') && !firstCol.includes('出納');
                        if (!isExternalOnly) continue;

                        if (firstCol.includes('外早') || (firstCol.includes('早'))) {
                            config.early = taskCode;
                        } else if (firstCol.includes('外中下') || firstCol.includes('外下') || (firstCol.includes('中下') || firstCol.includes('下'))) {
                            config.midLate = taskCode;
                        } else if (firstCol.includes('外中') || firstCol.includes('中')) {
                            config.middle = taskCode;
                        } else if (firstCol.includes('外晚') || firstCol.includes('晚')) {
                            config.late = taskCode;
                        }
                    } else {
                        // 其他表單類型：搜尋「XX早」「XX中」「XX中下」「XX下」「XX晚」
                        if (firstCol.includes(searchKey)) {
                            if (firstCol.includes('早')) {
                                config.early = taskCode;
                            } else if (firstCol.includes('中下') || (firstCol.includes('下') && !firstCol.includes('晚'))) {
                                config.midLate = taskCode;
                            } else if (firstCol.includes('中')) {
                                config.middle = taskCode;
                            } else if (firstCol.includes('晚')) {
                                config.late = taskCode;
                            }
                        }
                    }
                }
            }

            // 轉換為結果格式（找不到代碼則為 null，之後會略過）
            const result = {};
            for (const [sheetName, config] of Object.entries(sheetTypes)) {
                result[sheetName] = {
                    early: config.early || null,
                    middle: config.middle || null,
                    midLate: config.midLate || null,
                    late: config.late || null
                };
            }

            console.log('All task code mappings:', result);
            return result;
        }

        // 載入任務分配對照表（任務名稱 → 任務代碼）
        // 使用與班別相同的對照表，排除班別相關項目
        function loadTaskAssignMapping(rows) {
            if (!rows) {
                console.log('無法載入任務分配對照表');
                return {};
            }

            const mapping = {};
            // 第一欄是任務名稱，第二欄是代碼
            // 排除班別相關的項目
            const shiftPatterns = ['總控早', '總控中', '總控晚', '總控下',
                                   '一線早', '一線中', '一線晚', '一線下',
                                   '出納早', '出納中', '出納晚', '出納下',
                                   '外早', '外中', '外晚', '外下'];

            for (let i = 0; i < rows.length; i++) {
                const taskName = (rows[i][0] || '').trim();
                const taskCode = (rows[i][1] || '').trim();

                // 跳過班別相關項目
                const isShiftItem = shiftPatterns.some(pattern => taskName.includes(pattern));
                if (isShiftItem) {
                    continue;
                }

                if (taskName && taskCode) {
                    mapping[taskName] = taskCode;
                }
            }

            console.log('Task assign mapping loaded:', mapping);
            return mapping;
        }

        // 檢查是否為有效的班別時間
        function isValidShiftTime(value) {
            if (value === null || value === undefined) return false;
            const str = String(value).trim();
            return /^\d{3,4}$/.test(str);
        }

        // 判斷班別（支援各職務獨立切分點）
        // cutoffs: { early: number|null, midLate: number|null, late: number|null }
        // 返回: 'early', 'middle', 'midLate', 'late'
        function getShiftType(timeValue, cutoffs) {
            const time = parseInt(timeValue, 10);
            if (isNaN(time)) return null;

            const { early, midLate, late } = cutoffs;

            // 情況1: 只有晚班切點（如外帶預設）
            // 晚班切點後(含)為晚班，其他為早班
            if (early === null && midLate === null && late !== null) {
                return time >= late ? 'late' : 'early';
            }

            // 情況2: 只有早班和晚班切點（如總控預設）
            // 早班切點前(含)為早班，晚班切點後(含)為晚班，其他為中班
            if (early !== null && midLate === null && late !== null) {
                if (time <= early) return 'early';
                if (time >= late) return 'late';
                return 'middle';
            }

            // 情況3: 有早班、中下、晚班切點（如一線、出納預設）
            // 早班切點前(含)為早班
            // 中下切點到晚班切點之間(含中下，不含晚班)為中下班
            // 晚班切點後(含)為晚班
            // 其餘為中班
            if (early !== null && midLate !== null && late !== null) {
                if (time <= early) return 'early';
                if (time >= late) return 'late';
                if (time >= midLate && time < late) return 'midLate';
                return 'middle';
            }

            // 其他情況：預設返回中班
            return 'middle';
        }

        // 取得某月天數
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        // 格式化日期
        function formatDate(year, month, day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        let convertedData = null;

        // 表單提交
        document.getElementById('convertForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('excelFile');
            const yearMonth = document.getElementById('yearMonth').value || getNextMonth();
            const employeeSheetUrl = document.getElementById('employeeSheetUrl').value;
            const taskCodeSheetUrl = document.getElementById('taskCodeSheetUrl').value;

            // 取得各職務的切分點設定
            const shiftCutoffs = getShiftCutoffs();
            console.log('Shift cutoffs:', shiftCutoffs);

            if (!fileInput.files[0]) {
                showStatus('請選擇檔案', 'error');
                return;
            }

            showStatus('轉換中，請稍候...', 'loading');
            document.getElementById('submitBtn').disabled = true;

            try {
                // 解析年月
                let year, month;
                if (yearMonth.length === 6) {
                    year = parseInt(yearMonth.substring(0, 4), 10);
                    month = parseInt(yearMonth.substring(4, 6), 10);
                } else {
                    const now = new Date();
                    year = now.getFullYear();
                    month = now.getMonth() + 2;
                    if (month > 12) { month = 1; year++; }
                }

                const daysInMonth = getDaysInMonth(year, month);

                // 讀取 Excel 檔案
                const fileData = await fileInput.files[0].arrayBuffer();
                const workbook = XLSX.read(fileData, { type: 'array' });

                // 定義要處理的表單（班別表單）
                const sheetsToProcess = ['總控', '一線', '出納', '外帶'];
                const foundSheets = sheetsToProcess.filter(name => workbook.SheetNames.includes(name));

                // 檢查是否有任務分配表單
                const hasTaskAssignSheet = workbook.SheetNames.includes('任務分配');

                if (foundSheets.length === 0 && !hasTaskAssignSheet) {
                    showStatus('找不到可處理的表單（總控、一線、出納、外帶、任務分配）', 'error');
                    return;
                }

                // 載入對照表
                const [employeeMapping, taskCodeRows] = await Promise.all([
                    loadEmployeeMapping(employeeSheetUrl),
                    fetchGoogleSheet(taskCodeSheetUrl)
                ]);

                // 從對照表解析班別代碼和任務分配代碼
                const allTaskCodes = await loadAllTaskCodeMappings(taskCodeSheetUrl);
                const taskAssignMapping = loadTaskAssignMapping(taskCodeRows);

                console.log('Employee mapping:', employeeMapping);
                console.log('All task codes:', allTaskCodes);
                console.log('Task assign mapping:', taskAssignMapping);

                const result = [];

                // 處理每個表單
                for (const sheetName of foundSheets) {
                    const sheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    const taskCodes = allTaskCodes[sheetName];
                    const cutoffs = shiftCutoffs[sheetName];

                    console.log(`Processing sheet: ${sheetName}, taskCodes:`, taskCodes, 'cutoffs:', cutoffs);

                    // 從第二行開始（第一行是標題）
                    for (let rowIndex = 1; rowIndex < data.length; rowIndex++) {
                        const row = data[rowIndex];
                        const employeeName = String(row[0] || '').trim();
                        if (!employeeName) continue;

                        const employeeId = employeeMapping[employeeName] || employeeName;

                        for (let colIndex = 1; colIndex <= daysInMonth && colIndex < row.length; colIndex++) {
                            const cellValue = row[colIndex];
                            const cellStr = String(cellValue).trim();

                            if (isValidShiftTime(cellStr)) {
                                const day = colIndex;
                                const date = formatDate(year, month, day);
                                const shiftType = getShiftType(cellStr, cutoffs);

                                let taskCode;
                                if (shiftType === 'early') {
                                    taskCode = taskCodes.early;
                                } else if (shiftType === 'middle') {
                                    taskCode = taskCodes.middle;
                                } else if (shiftType === 'midLate') {
                                    taskCode = taskCodes.midLate;
                                } else if (shiftType === 'late') {
                                    taskCode = taskCodes.late;
                                }

                                // 如果找不到對應代碼，略過不轉換
                                if (taskCode) {
                                    result.push({
                                        date: date,
                                        employeeId: employeeId,
                                        taskCode: taskCode
                                    });
                                }
                            }
                        }
                    }
                }

                // 處理任務分配表單
                let processedTaskAssign = false;
                if (hasTaskAssignSheet && taskAssignMapping && Object.keys(taskAssignMapping).length > 0) {
                    const sheet = workbook.Sheets['任務分配'];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                    console.log('Processing sheet: 任務分配');
                    console.log('  data rows:', data.length);

                    // 任務分配表單結構：
                    // 第一欄：任務名稱
                    // 第二欄以後：日期（1號到最後一號）
                    // 儲存格內容：員工姓名

                    for (let rowIndex = 1; rowIndex < data.length; rowIndex++) {
                        const row = data[rowIndex];
                        const taskName = String(row[0] || '').trim();
                        if (!taskName) continue;

                        // 查找任務代碼
                        const taskCode = taskAssignMapping[taskName];
                        if (!taskCode) {
                            console.log(`  跳過任務: ${taskName} (無對應代碼)`);
                            continue;
                        }

                        // 處理每一天
                        for (let colIndex = 1; colIndex <= daysInMonth && colIndex < row.length; colIndex++) {
                            const cellValue = row[colIndex];
                            const employeeName = String(cellValue).trim();

                            if (employeeName) {
                                const day = colIndex;
                                const date = formatDate(year, month, day);
                                const employeeId = employeeMapping[employeeName] || employeeName;

                                result.push({
                                    date: date,
                                    employeeId: employeeId,
                                    taskCode: taskCode
                                });
                                processedTaskAssign = true;
                            }
                        }
                    }
                } else if (hasTaskAssignSheet) {
                    console.log('任務分配表單存在，但對照表中無對應的任務代碼，跳過處理');
                }

                // 統計處理的表單
                const processedSheets = [...foundSheets];
                if (processedTaskAssign) {
                    processedSheets.push('任務分配');
                }

                convertedData = result;

                if (result.length === 0) {
                    showStatus(`沒有可轉換的資料。請確認：1) Google Sheets 對照表是否設為公開 2) 對照表中是否有對應的任務代碼`, 'error');
                } else {
                    showStatus(`轉換成功！共 ${result.length} 筆資料（來自：${processedSheets.join('、')}）`, 'success');
                }
                showPreview(result);

            } catch (error) {
                showStatus('發生錯誤: ' + error.message, 'error');
                console.error(error);
            } finally {
                document.getElementById('submitBtn').disabled = false;
            }
        });

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        function showPreview(data) {
            const tbody = document.querySelector('#previewTable tbody');
            tbody.innerHTML = '';

            const previewData = data.slice(0, 20);
            previewData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.employeeId}</td>
                    <td>${row.taskCode}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('previewSection').style.display = 'block';
        }

        function downloadResult() {
            if (!convertedData) {
                alert('沒有可下載的資料');
                return;
            }

            // 建立 Excel 工作表
            const wsData = [
                ['日期', '工號', '任務代碼'],
                ...convertedData.map(row => [row.date, row.employeeId, row.taskCode])
            ];

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 20 }];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '轉換結果');

            XLSX.writeFile(wb, '轉換結果.xlsx');
        }
    </script>
</body>
</html>
